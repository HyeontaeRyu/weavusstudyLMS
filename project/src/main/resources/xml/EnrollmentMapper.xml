<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.project.mapper.EnrollmentMapper">

    <select id="existsEnrollment" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM ENROLLMENTS
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
    </select>

    <insert id="insertEnrollment">
        INSERT INTO ENROLLMENTS (user_id, course_id, status, progress_rate, created_at, updated_at)
        VALUES (#{userId}, #{courseId}, 'PENDING', 0.00, NOW(), NOW())
    </insert>

    <select id="findStatus" resultType="string">
        SELECT status
        FROM ENROLLMENTS
        WHERE user_id = #{userId}
          AND course_id = #{courseId} LIMIT 1
    </select>

    <delete id="deleteEnrollment">
        DELETE
        FROM ENROLLMENTS
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
          AND status = 'PENDING'
    </delete>

    <select id="findMyCourses" resultType="org.example.project.model.dto.MyCourseDto">
        SELECT c.id,
               c.title,
               e.progress_rate AS progressRate,
               e.status,
               er.score        AS finalGrade
        FROM ENROLLMENTS e
                 JOIN COURSES c ON e.course_id = c.id
                 LEFT JOIN EXAM_RESULTS er ON er.user_id = e.user_id AND er.exam_id IN (SELECT id
                                                                                        FROM EXAMS
                                                                                        WHERE course_id = c.id)
        WHERE e.user_id = #{userId}
          AND e.status IN ('ENROLLED', 'COMPLETED')
        ORDER BY e.updated_at DESC
    </select>

    <select id="findStatusByUserAndCourse"
            parameterType="map"
            resultType="string">
        SELECT status
        FROM ENROLLMENTS
        WHERE user_id = #{userId}
          AND course_id = #{courseId} LIMIT 1
    </select>

</mapper>